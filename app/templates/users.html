{% extends "base.html" %}
{% block content %}
<h2>Пользователи</h2>
<table class="table table-sm table-bordered table-params">
  <thead><tr><th>#</th><th>ФИО</th><th>Роль</th><th>Действия</th></tr></thead>
  <tbody>
  {% for u in users %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ u.fio() or '(нет данных)' }}</td>
      <td>{{ u.role.name if u.role else '(нет роли)' }}</td>
      <td>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('users.user_view', user_id=u.id) }}">Просмотр</a>
        {% if current_user.is_authenticated %}
          <a class="btn btn-sm btn-secondary" href="{{ url_for('users.user_edit', user_id=u.id) }}">Редактировать</a>
          <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-userid="{{ u.id }}" data-userfio="{{ u.fio() }}">Удалить</button>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

{% if current_user.is_authenticated %}
  <a class="btn btn-success" href="{{ url_for('users.user_create') }}">Создание пользователя</a>
{% endif %}

{# Modal #}
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" id="deleteForm">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Подтвердите удаление</h5></div>
        <div class="modal-body">
           <p id="deleteText">Вы уверены?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
          <button type="submit" class="btn btn-danger">Да</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
var deleteModal = document.getElementById('deleteModal')
deleteModal.addEventListener('show.bs.modal', function (event) {
  var button = event.relatedTarget
  var userid = button.getAttribute('data-userid')
  var fio = button.getAttribute('data-userfio') || ''
  var txt = deleteModal.querySelector('#deleteText')
  txt.textContent = 'Вы уверены, что хотите удалить пользователя ' + fio + '?'
  var form = deleteModal.querySelector('#deleteForm')
  form.action = '/user/' + userid + '/delete'  // POST target
})
</script>
{% endblock %}

